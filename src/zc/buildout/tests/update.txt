Automatic Buildout Updates
==========================

Get some info about the system:

  >>> import sys
  >>> sys.platform
  >>> import platform
  >>> platform.system()
  >>> platform.uname()

When a buildout is run, one of the first steps performed is to check for
updates to either zc.buildout or setuptools.  To
demonstrate this, we've created some "new releases" of buildout and
setuptools in a new_releases folder:

    >>> ls(new_releases)
    -  zc_buildout-91.0-py3-none-any.whl
    -  zc_buildout-NINETYNINE.NINETYNINE-py3-none-any.whl

Let's update the sample buildout.cfg to look in this area:

    >>> write(sample_buildout, 'buildout.cfg',
    ... """
    ... [buildout]
    ... find-links = %(new_releases)s
    ... index = %(new_releases)s
    ... parts = show-versions
    ... develop = showversions
    ...
    ... [show-versions]
    ... recipe = showversions
    ... """ % dict(new_releases=new_releases))

We'll also include a recipe that echos the versions of setuptools and
zc.buildout used:

    >>> mkdir(sample_buildout, 'showversions')

    >>> write(sample_buildout, 'showversions', 'showversions.py',
    ... """
    ... import pkg_resources
    ... import sys
    ... print_ = lambda *a: sys.stdout.write(' '.join(map(str, a))+'\\n')
    ...
    ... class Recipe:
    ...
    ...     def __init__(self, buildout, name, options):
    ...         pass
    ...
    ...     def install(self):
    ...         for project in ['zc.buildout']:
    ...             req = pkg_resources.Requirement.parse(project)
    ...             print_(project, pkg_resources.working_set.find(req).version)
    ...         return ()
    ...     update = install
    ... """)


    >>> write(sample_buildout, 'showversions', 'setup.py',
    ... """
    ... from setuptools import setup
    ...
    ... setup(
    ...     name = "showversions",
    ...     entry_points = {'zc.buildout': ['default = showversions:Recipe']},
    ...     )
    ... """)

The installed zc.buildout version is in development mode, so it won't upgrade itself.

    >>> print_(system(buildout), end='')
    Develop:...
    Installing show-versions.
    zc.buildout V.V

But if we run the buildout and tell it to use version 50, the buildout will upgrade itself:

    >>> print_(system(buildout + ' versions:zc.buildout=91.0'), end='')
    Getting distribution for 'zc.buildout==91.0'.
    Got zc.buildout V.V
    Upgraded:
      zc.buildout V.V
    Restarting.
    Generated script '/sample-buildout/bin/buildout'.
    Develop: '/sample-buildout/showversions'
    Updating show-versions.
    zc.buildout V.V

Now if we run the buildout without explicit version, the buildout will upgrade itself to the
newest version found in new releases:

    >>> print_(system(buildout), end='')
    Got zc.buildout NINETYNINE.NINETYNINE.
    Upgraded:
      zc.buildout version NINETYNINE.NINETYNINE;
    Restarting.
    Generated script '/sample-buildout/bin/buildout'.
    Develop: '/sample-buildout/showversions'
    Updating show-versions.
    zc.buildout NINETYNINE.NINETYNINE
