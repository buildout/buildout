version: 2.1

commands:

jobs:
  test:
    parameters:
      build-type:
        type: string
      python-version:
        type: string
    machine:
      image: ubuntu-2004:202111-01
    environment:
      BUILD_TYPE: << parameters.build-type >>
      PYTHON_VER: << parameters.python-version >>
    steps:
      - checkout
      - run:
          command: ./ci_build.sh

  install-python-and-test-ubuntu:
    parameters:
      python-version:
        type: string
    machine:
      image: ubuntu-2004:2022.10.1
    environment:
      BUILD_TYPE: bare_machines
      PYTHON_VER: << parameters.python-version >>
    steps:
      - run:
          command: sudo add-apt-repository ppa:deadsnakes/ppa
      - run:
          command: sudo apt-get update
      - run:
          command: sudo apt install -y build-essential python${PYTHON_VER}-dev
      - when:
          condition:
            and:
              - not:
                  matches:
                    pattern: ^3\.5$
                    value: << parameters.python-version >>
              - not:
                  matches:
                    pattern: ^2\.7$
                    value: << parameters.python-version >>
          steps:
            - run: sudo apt install -y python${PYTHON_VER}-distutils
      - run:
          command: sudo rm -rf /usr/lib/python*/EXTERNALLY-MANAGED
      - checkout
      - run:
          command: ./ci_build.sh

workflows:
  version: 2
  tests:
    jobs:
      - test:
          matrix:
            parameters:
              python-version: ["3.9"]
              build-type: ["debian_sys_container"]
